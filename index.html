<script>
  (function(){
    const CHAT_API_URL = 'https://forever-young-e9031e4612f3.herokuapp.com/chat';

    // --- 1) Persistent user ID via cookie ---
    function getOrCreateFYUID() {
      const cookieName = "fy_uid";
      const existing = document.cookie
        .split("; ")
        .find(row => row.startsWith(cookieName + "="));

      if (existing) {
        return existing.split("=")[1];
      } else {
        const uid = "web_" + crypto.randomUUID();
        document.cookie = `${cookieName}=${uid}; path=/; max-age=${60*60*24*365}; SameSite=Lax`;
        return uid;
      }
    }
    const FY_UID = getOrCreateFYUID();
    console.log("FY UID:", FY_UID);

    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const form = document.getElementById('composer');
    const sendBtn = document.getElementById('send');
    const errorBar = document.getElementById('errorBar');
    const clearBtn = document.getElementById('clearChatBtn');

    // Configure marked + highlight.js
    marked.setOptions({
      gfm: true,
      breaks: true,
      headerIds: false,
      mangle: false,
      highlight: function(code, lang) {
        try {
          const language = lang && hljs.getLanguage(lang) ? lang : 'plaintext';
          return hljs.highlight(code, { language }).value;
        } catch (e) {
          return hljs.highlight(code, { language: 'plaintext' }).value;
        }
      }
    });

    function renderMarkdown(text){
      const html = marked.parse(text || '');
      return DOMPurify.sanitize(html, { RETURN_TRUSTED_TYPE: false });
    }

    function autosize(){ input.style.height = 'auto'; input.style.height = input.scrollHeight + 'px'; }
    input.addEventListener('input', autosize); autosize();

    function scrollToBottom(){ chat.scrollTop = chat.scrollHeight; }

    function botAvatar(){ return '<svg ...>...</svg>'; } // shortened for clarity
    function userAvatar(){ return '<svg ...>...</svg>'; }

    function messageRow(role){
      const row = document.createElement('div');
      row.className = role==='user' ? 'flex items-start gap-3 fade-in justify-end' : 'flex items-start gap-3 fade-in';
      const avatar = document.createElement('div');
      avatar.className = 'h-8 w-8 rounded-full bg-brand-500/10 grid place-items-center shrink-0';
      avatar.innerHTML = role === 'user' ? userAvatar() : botAvatar();
      const bubble = document.createElement('div');
      bubble.className = role==='user'
        ? 'bubble user bg-brand-500 text-white rounded-2xl px-4 py-2 text-[15px] leading-relaxed shadow-sm max-w-[85%] sm:max-w-[75%]'
        : 'bubble bot bg-[rgb(246,242,238)] rounded-2xl px-4 py-2 text-[15px] leading-relaxed shadow-sm max-w-[85%] sm:max-w-[75%] prose-like';
      if(role==='user'){ row.appendChild(bubble); row.appendChild(avatar); }
      else { row.appendChild(avatar); row.appendChild(bubble); }
      return {row, bubble};
    }

    function addMessage(role, text){
      const {row, bubble} = messageRow(role);
      const inner = document.createElement('div');
      inner.setAttribute('data-html','');
      inner.innerHTML = renderMarkdown(text);
      bubble.appendChild(inner);
      chat.appendChild(row);
      return bubble;
    }

    function addTyping(){
      const {row, bubble} = messageRow('bot');
      bubble.innerHTML = '<div class="typing"><span></span><span></span><span></span></div>';
      chat.appendChild(row);
      return {row, bubble};
    }

    async function sendMessage(text){
      hideError();
      addMessage('user', text);
      scrollToBottom();
      const typing = addTyping();
      scrollToBottom();
      try {
        const res = await fetch(CHAT_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            user_id: FY_UID // <-- Send persistent ID
          })
        });
        const contentType = res.headers.get('content-type') || '';
        const bodyText = await res.text();
        if (!res.ok) throw new Error(`Server ${res.status} — ${bodyText.slice(0,160)}`);
        if (!contentType.includes('application/json')) throw new Error(`Expected JSON, got ${contentType} — ${bodyText.slice(0,160)}`);
        const data = JSON.parse(bodyText);
        const reply = (data && data.reply) || '';
        typing.bubble.innerHTML = renderMarkdown(reply);
      } catch (err){
        typing.row.remove();
        showError(err?.message || 'Network error');
      } finally {
        scrollToBottom();
      }
    }

    function showError(msg){ errorBar.textContent = msg; errorBar.classList.remove('hidden'); }
    function hideError(){ errorBar.classList.add('hidden'); }

    if (clearBtn) {
      clearBtn.addEventListener('click', ()=>{
        chat.innerHTML = '';
        const welcomeRow = document.createElement('div');
        welcomeRow.className = 'flex items-start gap-3 fade-in';
        welcomeRow.innerHTML = `<div class="h-8 w-8 rounded-full bg-brand-500/10 grid place-items-center shrink-0">${botAvatar()}</div><div class="bubble bot bg-[rgb(246,242,238)] rounded-2xl px-4 py-2 text-[15px] leading-relaxed shadow-sm prose-like"><p>Hi! I’m your Forever Young AI assistant. How can I help you today?</p></div>`;
        chat.appendChild(welcomeRow);
      });
    }

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const text = (input.value || '').trim();
      if(!text) return;
      sendBtn.disabled = true;
      sendMessage(text).finally(()=>{ sendBtn.disabled = false; });
      input.value=''; autosize(); input.focus();
    });
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        form.requestSubmit();
      }
    });
  })();
</script>
