<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FY Chat Demo</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #faf9f8; }
    .fy-chat-demo { display: flex; flex-direction: column; min-height: 100vh; }
    header { text-align: center; padding: .75rem 1rem; background: #fff; border-bottom: 1px solid #e0d6cc; }
    header h1 { font-family: 'Brush Script MT', cursive; font-size: 2rem; color: #c89b6d; margin: 0; line-height: 1.1; }
    .fy-main { flex: 1; display: flex; justify-content: center; align-items: flex-start; padding: .25rem 0; }
    .chat-container { background: #fff; border-radius: 1rem; width: 100%; max-width: 600px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #e0d6cc; box-shadow: 0 4px 12px rgba(0,0,0,.08); }
    .chat-messages { flex: 1; padding: .75rem; overflow-y: auto; display: flex; flex-direction: column; gap: .75rem; background: #faf9f8; }
    .message { padding: .75rem 1rem; border-radius: 1rem; max-width: 75%; word-wrap: break-word; animation: fyFadeIn .3s ease-in-out; font-size: .95rem; }
    .message.user { background: #c89b6d; color: #fff; align-self: flex-end; }
    .message.bot { background: #f1e8e0; color: #333; align-self: flex-start; }
    @keyframes fyFadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .chat-input { display: flex; padding: .75rem; background: #fff; border-top: 1px solid #e0d6cc; }
    .chat-input input { flex: 1; padding: .75rem; border: 1px solid #d3c3b7; outline: none; border-radius: .5rem; font-size: 1rem; color: #000; }
    .chat-input button { margin-left: .5rem; padding: .75rem 1rem; background: #c89b6d; border: none; border-radius: .5rem; color: #fff; cursor: pointer; font-size: 1rem; transition: background .2s; }
    .chat-input button:hover { background: #a67449; }
  </style>
</head>
<body>
  <div class="fy-chat-demo">
    <header>
      <h1>Hello I’m Fy</h1>
      Your intelligent demo assistant. Let’s Chat.
    </header>

    <div class="fy-main">
      <div class="chat-container">
        <div id="fyChatMessages" class="chat-messages" role="log" aria-live="polite" aria-relevant="additions">
          <div class="message bot">Hello! I’m your Forever Young AI assistant. How can I help you today?</div>
        </div>

        <form id="fyChatForm" class="chat-input" autocomplete="off" novalidate>
          <input id="fyUserInput" type="text" placeholder="Type a message..." aria-label="Type a message" />
          <button id="fySendBtn" type="submit">Send</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const CHAT_API_URL = 'https://forever-young-e9031e4612f3.herokuapp.com/chat';

      function attachHandlers() {
        const chatMessages = document.getElementById('fyChatMessages');
        const inputEl = document.getElementById('fyUserInput');
        const sendBtn = document.getElementById('fySendBtn');
        const formEl = document.getElementById('fyChatForm');
        if (!chatMessages || !inputEl || !sendBtn || !formEl) return;

        let sending = false;

        window.fySendMessage = async function fySendMessage(evt) {
          if (evt && evt.preventDefault) evt.preventDefault();
          if (sending) return false;

          const message = (inputEl.value || '').trim();
          if (!message) return false;

          sending = true;
          sendBtn.disabled = true;
          sendBtn.setAttribute('aria-busy', 'true');

          appendBubble(message, 'user');
          inputEl.value = '';
          inputEl.focus();
          scrollToBottom();

          const typingEl = appendBubble('…', 'bot', true);

          try {
            const reply = await fetchReply(message);
            typingEl.textContent = reply || "Sorry, I didn’t understand.";
          } catch (err) {
            typingEl.textContent = `Error: ${err && err.message ? err.message : 'Network error'}`;
          } finally {
            sending = false;
            sendBtn.disabled = false;
            sendBtn.removeAttribute('aria-busy');
          }

          scrollToBottom();
          return false;
        };

        formEl.addEventListener('submit', window.fySendMessage);

        function appendBubble(text, role = 'bot', returnEl = false) {
          const div = document.createElement('div');
          div.className = `message ${role}`;
          div.textContent = text;
          chatMessages.appendChild(div);
          return returnEl ? div : undefined;
        }

        function scrollToBottom() {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function fetchReply(userMessage) {
          const res = await fetch(CHAT_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userMessage })
          });

          const contentType = res.headers.get('content-type') || '';
          const bodyText = await res.text();

          if (!res.ok) {
            throw new Error(`Server ${res.status} — ${bodyText.slice(0, 200)}`);
          }
          if (!contentType.includes('application/json')) {
            throw new Error(`Expected JSON, got ${contentType} — ${bodyText.slice(0, 200)}`);
          }

          let data;
          try {
            data = JSON.parse(bodyText);
          } catch {
            throw new Error(`Bad JSON — ${bodyText.slice(0, 200)}`);
          }
          return (data && data.reply) || '';
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachHandlers);
      } else {
        attachHandlers();
      }
    })();
  </script>
</body>
</html>
